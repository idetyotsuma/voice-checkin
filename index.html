<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨å®‰å®šç‰ˆï¼‰</title>

<style>
  body {
    font-family: sans-serif;
    margin: 40px;
    text-align: center;
  }

  /* â˜… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆâ—‹ Ã— â–³ï¼‰ã‚’ã•ã‚‰ã«å¤§ãã */
  #status {
    font-size: 140px;
    margin: 40px 0;
    font-weight: bold;
  }

  /* â˜… æ‰€å±ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤§ããå¤ªã */
  #log {
    margin-top: 30px;
    font-size: 42px;
    font-weight: bold;
    color: #222;
    line-height: 1.4;
  }

  /* â˜… éä¼šå“¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å°‚ç”¨ã®å¼·èª¿ãƒ‡ã‚¶ã‚¤ãƒ³ */
  .non-member-warning {
    font-size: 60px;
    font-weight: 900;
    color: #b00000;
    background: #fff3a0;
    padding: 25px 30px;
    border-radius: 16px;
    display: inline-block;
    margin-top: 20px;
  }

  /* â˜… ãƒœã‚¿ãƒ³ã‚’ã•ã‚‰ã«å¤§ãã */
  button {
    font-size: 44px;
    padding: 26px 45px;
    margin: 20px;
  }

  /* â˜… å…¥åŠ›æ¬„ã‚‚å¤§ãã */
  input {
    font-size: 44px;
    padding: 18px;
    width: 520px;
  }

  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚‚å¤§ãã */
  h1 {
    font-size: 70px;
    margin-bottom: 40px;
  }
</style>

<!-- ã²ã‚‰ãŒãªå¤‰æ›ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/kuromoji@0.1.2/build/kuromoji.js"></script>
<script src="https://unpkg.com/kuroshiro@1.1.0/dist/kuroshiro.min.js"></script>
<script src="https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
</head>

<body>

<h1>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ </h1>

<div>
  <input id="nameInput" type="text" placeholder="åå‰ã‚’å…¥åŠ›ã¾ãŸã¯éŸ³å£°å…¥åŠ›">
  <button id="micBtn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="status"></div>
<div id="log"></div>

<script>
// ====== è¨­å®š ======
const API_URL = "https://script.google.com/macros/s/AKfycbx4JFa8wL7E2KdTvLkwuotxRahR_kx5U6HlY0iHVMacuBbCjdKLxizV6OxMsqwFXgqahQ/exec";

// ====== Kuroshiro åˆæœŸåŒ– ======
let kuroshiroReady = false;
let kuroshiro;

window.addEventListener("load", async () => {
  kuroshiro = new Kuroshiro();
  await kuroshiro.init(new KuromojiAnalyzer({ dictPath: "dict/" }));
  kuroshiroReady = true;
  console.log("Kuroshiro initialized");
});

// ====== æ­£è¦åŒ–ï¼ˆæ¼¢å­— â†’ ã²ã‚‰ãŒãªï¼‰ ======
async function normalizeHiragana(str) {
  if (!str) return "";

  let waitCount = 0;
  while (!kuroshiroReady && waitCount < 20) {
    await new Promise(resolve => setTimeout(resolve, 100));
    waitCount++;
  }

  str = str.replace(/ã§ã™|ã•ã‚“|æ§˜/g, "");
  str = str.replace(/[ã€‚ã€ãƒ»]/g, "");
  str = str.replace(/[\sã€€]+/g, "");

  str = await kuroshiro.convert(str, { to: "hiragana" });
  return str.trim();
}

// ====== éŸ³å£°å…¥åŠ› ======
document.getElementById("micBtn").onclick = () => {
  const recognition = new webkitSpeechRecognition();
  recognition.lang = "ja-JP";

  recognition.onresult = async (event) => {
    let text = event.results[0][0].transcript;
    text = await normalizeHiragana(text);
    document.getElementById("nameInput").value = text;

    setTimeout(() => searchName(text), 500);
  };

  recognition.onerror = (event) => {
    setStatus("Ã—", "éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ï¼š" + event.error);
  };

  recognition.start();
};

// ====== æ¤œç´¢ãƒœã‚¿ãƒ³ ======
document.getElementById("searchBtn").onclick = async () => {
  const name = await normalizeHiragana(document.getElementById("nameInput").value);
  searchName(name);
};

// ====== åå‰æ¤œç´¢ ======
async function searchName(name) {
  if (!name) return;

  setStatus("â³", "æ¤œç´¢ä¸­â€¦");

  try {
    const res = await fetch(`${API_URL}?name=${encodeURIComponent(name)}`);
    const data = await res.json();

    // â˜… éä¼šå“¡ï¼ˆè©²å½“è€…ãªã—ï¼‰
    if (!data.results || data.results.length === 0) {
      document.getElementById("status").textContent = "Ã—";

      document.getElementById("log").innerHTML =
        `<div class="non-member-warning">
           éä¼šå“¡ã®æ–¹ã¯å—ä»˜å‰ã«<br>å¿…ãšãŠæ”¯æ‰•ã„ãŒå¿…è¦ã§ã™
         </div>`;

      setTimeout(() => {}, 6000);
      return;
    }

    // â˜… è¤‡æ•°å€™è£œ
    if (data.results.length > 1) {
      setStatus("â–³", `å€™è£œãŒè¤‡æ•°ã‚ã‚Šã¾ã™ï¼ˆ${data.results.length}ä»¶ï¼‰`);
      setTimeout(() => {}, 6000);
      return;
    }

    const person = data.results[0];

    // â˜… ä¼šå“¡ï¼ˆæ‰€å±è¡¨ç¤ºï¼‰
    setStatus("â—‹", `${person.name} ã•ã‚“ï¼ˆ${person.company}ï¼‰ã‚’å—ä»˜ã—ã¾ã™`);

    setTimeout(() => {}, 6000);

    await checkIn(person.id);

  } catch (e) {
    setStatus("Ã—", "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    setTimeout(() => {}, 6000);
  }
}

// ====== å—ä»˜æ¸ˆã¿æ›´æ–° ======
async function checkIn(id) {
  try {
    await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({ id })
    });
    log(`å—ä»˜æ¸ˆã¿ã«æ›´æ–°ã—ã¾ã—ãŸï¼ˆID: ${id}ï¼‰`);
  } catch (e) {
    log("å—ä»˜æ¸ˆã¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// ====== UI ======
function setStatus(symbol, message) {
  document.getElementById("status").textContent = symbol;
  document.getElementById("log").textContent = message;
}

function log(message) {
  document.getElementById("log").textContent = message;
}
</script>

</body>
</html>
