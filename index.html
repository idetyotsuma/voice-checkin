<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨å®‰å®šç‰ˆï¼‰</title>

<style>
  body {
    font-family: sans-serif;
    margin: 40px;
    text-align: center;
  }

  #status {
    font-size: 140px;
    margin: 40px 0;
    font-weight: bold;
  }

  #log {
    margin-top: 30px;
    font-size: 42px;
    font-weight: bold;
    color: #222;
    line-height: 1.4;
  }

  /* éä¼šå“¡ã®å¼·èª¿è¡¨ç¤º */
  .non-member-warning {
    font-size: 60px;
    font-weight: 900;
    color: #b00000;
    background: #fff3a0;
    padding: 25px 30px;
    border-radius: 16px;
    display: inline-block;
    margin-top: 20px;
  }

  /* åç°¿ã«ãªã„å ´åˆã®è¡¨ç¤º */
  .not-found {
    font-size: 60px;
    font-weight: 900;
    color: #444;
    padding: 20px;
    display: inline-block;
  }

  button {
    font-size: 44px;
    padding: 26px 45px;
    margin: 20px;
  }

  input {
    font-size: 44px;
    padding: 18px;
    width: 520px;
  }

  h1 {
    font-size: 70px;
    margin-bottom: 40px;
  }
</style>

<script src="https://unpkg.com/kuromoji@0.1.2/build/kuromoji.js"></script>
<script src="https://unpkg.com/kuroshiro@1.1.0/dist/kuroshiro.min.js"></script>
<script src="https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
</head>

<body>

<h1>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ </h1>

<div>
  <input id="nameInput" type="text" placeholder="åå‰ã‚’å…¥åŠ›ã¾ãŸã¯éŸ³å£°å…¥åŠ›">
  <button id="micBtn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="status"></div>
<div id="log"></div>

<script>
// ====== è¨­å®š ======
const API_URL = "https://script.google.com/macros/s/AKfycbx4JFa8wL7E2KdTvLkwuotxRahR_kx5U6HlY0iHVMacuBbCjdKLxizV6OxMsqwFXgqahQ/exec";

// ====== Kuroshiro åˆæœŸåŒ– ======
let kuroshiroReady = false;
let kuroshiro;

window.addEventListener("load", async () => {
  kuroshiro = new Kuroshiro();
  await kuroshiro.init(new KuromojiAnalyzer({ dictPath: "dict/" }));
  kuroshiroReady = true;
});

// ====== æ­£è¦åŒ– ======
async function normalizeHiragana(str) {
  if (!str) return "";

  let waitCount = 0;
  while (!kuroshiroReady && waitCount < 20) {
    await new Promise(resolve => setTimeout(resolve, 100));
    waitCount++;
  }

  str = str.replace(/ã§ã™|ã•ã‚“|æ§˜/g, "");
  str = str.replace(/[ã€‚ã€ãƒ»]/g, "");
  str = str.replace(/[\sã€€]+/g, "");

  str = await kuroshiro.convert(str, { to: "hiragana" });
  return str.trim();
}

// ====== éŸ³å£°å…¥åŠ› ======
document.getElementById("micBtn").onclick = () => {
  const recognition = new webkitSpeechRecognition();
  recognition.lang = "ja-JP";

  recognition.onresult = async (event) => {
    let text = event.results[0][0].transcript;
    text = await normalizeHiragana(text);
    document.getElementById("nameInput").value = text;

    setTimeout(() => searchName(text), 500);
  };

  recognition.onerror = (event) => {
    setStatus("Ã—", "éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ï¼š" + event.error);
  };

  recognition.start();
};

// ====== æ¤œç´¢ãƒœã‚¿ãƒ³ ======
document.getElementById("searchBtn").onclick = async () => {
  const name = await normalizeHiragana(document.getElementById("nameInput").value);
  searchName(name);
};

// ====== åå‰æ¤œç´¢ ======
async function searchName(name) {
  if (!name) return;

  setStatus("â³", "æ¤œç´¢ä¸­â€¦");

  try {
    const res = await fetch(`${API_URL}?name=${encodeURIComponent(name)}`);
    const data = await res.json();

    // â˜… åç°¿ã«å­˜åœ¨ã—ãªã„
    if (!data.results || data.results.length === 0) {
      document.getElementById("status").textContent = "Ã—";
      document.getElementById("log").innerHTML =
        `<div class="not-found">åç°¿ã«ãŠåå‰ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      setTimeout(() => {}, 6000);
      document.getElementById("nameInput").value = "";
      return;
    }

    // â˜… è¤‡æ•°å€™è£œ
    if (data.results.length > 1) {
      setStatus("â–³", `å€™è£œãŒè¤‡æ•°ã‚ã‚Šã¾ã™ï¼ˆ${data.results.length}ä»¶ï¼‰`);
      setTimeout(() => {}, 6000);
      return;
    }

    const person = data.results[0];

    // ====== æ‰€å±åˆ¤å®šï¼ˆEåˆ—ï¼‰ ======
    const company = (person.company || "")
      .replace(/\s+/g, "")   // å…¨ã¦ã®ç©ºç™½ã‚’é™¤å»
      .trim();

    // â˜… éä¼šå“¡ï¼ˆè¡¨è¨˜ã‚†ã‚Œã«ã‚‚å¯¾å¿œï¼‰
    if (company.includes("éä¼šå“¡")) {
      document.getElementById("status").textContent = "Ã—";
      document.getElementById("log").innerHTML =
        `<div class="non-member-warning">
           å—ä»˜ã«ã¦å‚åŠ è²»ã‚’ãŠæ”¯æ‰•ã„ãã ã•ã„
         </div>`;
      setTimeout(() => {}, 6000);
      document.getElementById("nameInput").value = "";
      return;
    }

    // â˜… ä¼šå“¡ï¼ˆåŸ¼ç‰çœŒè‡ªé–‰ç—‡å”ä¼šä¼šå“¡ï¼‰
    if (company.includes("åŸ¼ç‰çœŒè‡ªé–‰ç—‡å”ä¼šä¼šå“¡")) {
      setStatus("â—‹", `${person.name} ã•ã‚“ï¼ˆ${company}ï¼‰ã‚’å—ä»˜ã—ã¾ã™`);
      setTimeout(() => {}, 6000);
      await checkIn(person.id);
      document.getElementById("nameInput").value = "";
      return;
    }

    // â˜… æƒ³å®šå¤–ã®å€¤ï¼ˆä¿é™ºï¼‰
    setStatus("Ã—", "æ‰€å±æƒ…å ±ãŒä¸æ˜ã§ã™");
    setTimeout(() => {}, 6000);
    document.getElementById("nameInput").value = "";

  } catch (e) {
    setStatus("Ã—", "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    setTimeout(() => {}, 6000);
    document.getElementById("nameInput").value = "";
  }
}

// ====== å—ä»˜æ¸ˆã¿æ›´æ–° ======
async function checkIn(id) {
  try {
    await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({ id })
    });
    log(`å—ä»˜æ¸ˆã¿ã«æ›´æ–°ã—ã¾ã—ãŸï¼ˆID: ${id}ï¼‰`);
  } catch (e) {
    log("å—ä»˜æ¸ˆã¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// ====== UI ======
function setStatus(symbol, message) {
  document.getElementById("status").textContent = symbol;
  document.getElementById("log").textContent = message;
}

function log(message) {
  document.getElementById("log").textContent = message;
}
</script>

</body>
</html>

