<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨å®‰å®šç‰ˆï¼‰</title>
<style>
  body { font-family: sans-serif; margin: 40px; text-align: center; }
  #status { font-size: 80px; margin: 30px 0; }
  #log { margin-top: 20px; font-size: 18px; color: #444; }
  button { font-size: 20px; padding: 10px 20px; margin: 10px; }
  input { font-size: 20px; padding: 8px; width: 300px; }
</style>

<!-- â˜… æ¼¢å­— â†’ ã²ã‚‰ãŒãªå¤‰æ›ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<!-- kuromoji.jsï¼ˆå½¢æ…‹ç´ è§£æå™¨ï¼‰ -->
<script src="https://unpkg.com/kuromoji@0.1.2/build/kuromoji.js"></script>

<!-- Kuroshiro æœ¬ä½“ -->
<script src="https://unpkg.com/kuroshiro@1.1.0/dist/kuroshiro.min.js"></script>

<!-- Kuroshiro ç”¨ã® Kuromoji ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ -->
<script src="https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
</head>
<body>

<h1>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ </h1>

<div>
  <input id="nameInput" type="text" placeholder="åå‰ã‚’å…¥åŠ›ã¾ãŸã¯éŸ³å£°å…¥åŠ›">
  <button id="micBtn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="status"></div>
<div id="log"></div>

<script>
// ====== è¨­å®š ======
const API_URL = "https://script.google.com/macros/s/AKfycbyHPvz2HjouU5W4CMPgouRK_ux5oIQGOcIW8rRYQPvjSElG87viyVnZcgCcJNYdamtm0A/exec";  // â† Apps Script ã® /exec URL ã‚’å…¥ã‚Œã‚‹

// ====== Kuroshiro åˆæœŸåŒ– ======
let kuroshiroReady = false;
let kuroshiro;

window.addEventListener("load", async () => {
  kuroshiro = new Kuroshiro();
  await kuroshiro.init(new KuromojiAnalyzer());
  kuroshiroReady = true;
  console.log("Kuroshiro initialized");
});

// ====== æ­£è¦åŒ–ï¼ˆæ¼¢å­— â†’ ã²ã‚‰ãŒãªå¯¾å¿œï¼‰ ======
async function normalizeHiragana(str) {
  if (!str) return "";

  // åˆæœŸåŒ–å¾…ã¡ï¼ˆæœ€å¤§ 2 ç§’ï¼‰
  let waitCount = 0;
  while (!kuroshiroReady && waitCount < 20) {
    await new Promise(resolve => setTimeout(resolve, 100));
    waitCount++;
  }

  // æ•¬ç§°ãƒ»èªå°¾å‰Šé™¤
  str = str.replace(/ã§ã™|ã•ã‚“|æ§˜/g, "");

  // è¨˜å·å‰Šé™¤
  str = str.replace(/[ã€‚ã€ãƒ»]/g, "");

  // å…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
  str = str.replace(/[\sã€€]+/g, "");

  // â˜… æ¼¢å­— â†’ ã²ã‚‰ãŒãªå¤‰æ›
  str = await kuroshiro.convert(str, { to: "hiragana" });

  return str.trim();
}

// ====== éŸ³å£°å…¥åŠ› ======
document.getElementById("micBtn").onclick = () => {
  const recognition = new webkitSpeechRecognition();
  recognition.lang = "ja-JP";

  recognition.onresult = async (event) => {
    let text = event.results[0][0].transcript;
    text = await normalizeHiragana(text);
    document.getElementById("nameInput").value = text;

    // â˜… aborted å›é¿ã®ãŸã‚é…å»¶å®Ÿè¡Œ
    setTimeout(() => searchName(text), 500);
  };

  recognition.onerror = (event) => {
    console.log("SpeechRecognition error:", event.error);
    setStatus("Ã—", "éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ï¼š" + event.error);
  };

  recognition.start();
};

// ====== æ¤œç´¢ãƒœã‚¿ãƒ³ ======
document.getElementById("searchBtn").onclick = async () => {
  const name = await normalizeHiragana(document.getElementById("nameInput").value);
  searchName(name);
};

// ====== åå‰æ¤œç´¢ ======
async function searchName(name) {
  if (!name) return;

  setStatus("â³", "æ¤œç´¢ä¸­â€¦");

  try {
    const res = await fetch(`${API_URL}?name=${encodeURIComponent(name)}`);
    const data = await res.json();

    if (!data.results || data.results.length === 0) {
      setStatus("Ã—", "è©²å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }

    if (data.results.length > 1) {
      setStatus("â–³", `å€™è£œãŒè¤‡æ•°ã‚ã‚Šã¾ã™ï¼ˆ${data.results.length}ä»¶ï¼‰`);
      return;
    }

    const person = data.results[0];

    // â˜… æ‰€å±ã‚‚è¡¨ç¤º
    setStatus("â—‹", `${person.name} ã•ã‚“ï¼ˆ${person.company}ï¼‰ã‚’å—ä»˜ã—ã¾ã™`);

    await checkIn(person.id);

  } catch (e) {
    setStatus("Ã—", "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
  }
}

// ====== å—ä»˜æ¸ˆã¿æ›´æ–° ======
async function checkIn(id) {
  try {
    await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({ id })
    });
    log(`å—ä»˜æ¸ˆã¿ã«æ›´æ–°ã—ã¾ã—ãŸï¼ˆID: ${id}ï¼‰`);
  } catch (e) {
    log("å—ä»˜æ¸ˆã¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// ====== UI ======
function setStatus(symbol, message) {
  document.getElementById("status").textContent = symbol;
  document.getElementById("log").textContent = message;
}

function log(message) {
  document.getElementById("log").textContent = message;
}
</script>

</body>
</html>




