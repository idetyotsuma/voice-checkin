<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆDåˆ—ã²ã‚‰ãŒãªå¯¾å¿œï¼‰</title>
<style>
  body { font-family: sans-serif; margin: 40px; text-align: center; }
  #status { font-size: 80px; margin: 30px 0; }
  #log { margin-top: 20px; font-size: 18px; color: #444; }
  button { font-size: 20px; padding: 10px 20px; margin: 10px; }
  input { font-size: 20px; padding: 8px; width: 300px; }
</style>
</head>
<body>

<h1>éŸ³å£°å—ä»˜ã‚·ã‚¹ãƒ†ãƒ </h1>

<div>
  <input id="nameInput" type="text" placeholder="åå‰ã‚’å…¥åŠ›ã¾ãŸã¯éŸ³å£°å…¥åŠ›">
  <button id="micBtn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="status"></div>
<div id="log"></div>

<script>
// ====== è¨­å®š ======
const API_URL = "https://script.google.com/macros/s/AKfycbxu4nEhw2QDiUMCGfFL53iNubqVEhAWDihsYZdFeI7kJyaibmNpHsce9g-MiSSDyMb21g/exec";  // â†å·®ã—æ›¿ãˆå¿…é ˆ

// ====== ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãªå¤‰æ› ======
function toHiragana(str) {
  return str.replace(/[\u30a1-\u30f6]/g, m =>
    String.fromCharCode(m.charCodeAt(0) - 0x60)
  );
}

// ====== éŸ³å£°å…¥åŠ›ã®æ­£è¦åŒ– ======
function normalizeHiragana(str) {
  if (!str) return "";

  str = toHiragana(str);          // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
  str = str.replace(/ã•ã‚“|æ§˜/g, ""); // æ•¬ç§°å‰Šé™¤
  str = str.replace(/[\sã€€]+/g, ""); // å…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
  str = str.replace(/[ã€‚ã€ãƒ»]/g, ""); // è¨˜å·å‰Šé™¤

  return str.trim();
}

// ====== éŸ³å£°å…¥åŠ› ======
document.getElementById("micBtn").onclick = () => {
  const recognition = new webkitSpeechRecognition();
  recognition.lang = "ja-JP";
  recognition.start();

  recognition.onresult = (event) => {
    let text = event.results[0][0].transcript;
    text = normalizeHiragana(text);
    document.getElementById("nameInput").value = text;
    searchName(text);
  };
};

// ====== æ¤œç´¢ãƒœã‚¿ãƒ³ ======
document.getElementById("searchBtn").onclick = () => {
  const name = normalizeHiragana(document.getElementById("nameInput").value);
  searchName(name);
};

// ====== åå‰æ¤œç´¢ ======
async function searchName(name) {
  if (!name) return;

  setStatus("â³", "æ¤œç´¢ä¸­â€¦");

  try {
    const res = await fetch(`${API_URL}?name=${encodeURIComponent(name)}`);
    const data = await res.json();

    if (!data.results || data.results.length === 0) {
      setStatus("Ã—", "è©²å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }

    if (data.results.length > 1) {
      setStatus("â–³", `å€™è£œãŒè¤‡æ•°ã‚ã‚Šã¾ã™ï¼ˆ${data.results.length}ä»¶ï¼‰`);
      return;
    }

    const person = data.results[0];

    // â˜… æ‰€å±ã‚’å«ã‚ã¦è¡¨ç¤º
    setStatus("â—‹", `${person.name} ã•ã‚“ï¼ˆ${person.company}ï¼‰ã‚’å—ä»˜ã—ã¾ã™`);

    await checkIn(person.id);

  } catch (e) {
    setStatus("Ã—", "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
  }
}

// ====== å—ä»˜æ¸ˆã¿æ›´æ–° ======
async function checkIn(id) {
  try {
    await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({ id })
    });
    log(`å—ä»˜æ¸ˆã¿ã«æ›´æ–°ã—ã¾ã—ãŸï¼ˆID: ${id}ï¼‰`);
  } catch (e) {
    log("å—ä»˜æ¸ˆã¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// ====== UI ======
function setStatus(symbol, message) {
  document.getElementById("status").textContent = symbol;
  document.getElementById("log").textContent = message;
}

function log(message) {
  document.getElementById("log").textContent = message;
}
</script>

</body>
</html>